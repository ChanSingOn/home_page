<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>全面单位换算工具</title>
  <!-- Tailwind CSS v3 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <!-- 配置Tailwind自定义颜色和字体，启用暗色模式 -->
  <script>
    tailwind.config = {
      darkMode: 'class', // 启用类模式的暗色模式
      theme: {
        extend: {
          colors: {
            primary: '#3B82F6', // 蓝色作为主色调，代表专业和可靠
            secondary: '#10B981', // 绿色作为辅助色，用于结果展示
            neutral: '#F3F4F6', // 浅灰色作为中性色
            dark: {
              bg: '#1E293B',
              card: '#334155',
              text: '#F8FAFC',
              secondary: '#94A3B8'
            }
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <!-- 自定义工具类 -->
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .transition-custom {
        transition: all 0.3s ease;
      }
      .card-shadow {
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      }
      .dark .card-shadow {
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.15);
      }
    }
  </style>
</head>
<body class="bg-gray-50 dark:bg-dark-bg text-gray-800 dark:text-dark-text min-h-screen font-sans transition-custom">
  <div class="container mx-auto px-4 py-8 max-w-4xl">
    <!-- 头部区域：标题和主题切换按钮 -->
    <header class="flex flex-col md:flex-row justify-between items-center mb-10">
      <div class="text-center md:text-left mb-4 md:mb-0">
        <h1 class="text-[clamp(2rem,5vw,3rem)] font-bold mb-2">单位换算工具</h1>
        <p class="text-gray-500 dark:text-dark-secondary text-lg">简单、快速地进行各种单位转换</p>
      </div>
      
      <!-- 暗色模式切换按钮 -->
      <button id="themeToggle" class="p-2 rounded-full bg-gray-200 dark:bg-dark-card hover:bg-gray-300 dark:hover:bg-gray-700 transition-custom">
        <i class="fa fa-sun-o dark:hidden text-yellow-500 text-xl"></i>
        <i class="fa fa-moon-o hidden dark:inline text-blue-200 text-xl"></i>
      </button>
    </header>
    
    <!-- 主要换算卡片 -->
    <div class="bg-white dark:bg-dark-card rounded-2xl p-6 md:p-8 card-shadow mb-8 transform hover:scale-[1.01] transition-custom">
      <!-- 单位类型选择器 -->
      <div class="mb-8">
        <label class="block text-gray-700 dark:text-dark-secondary font-medium mb-2">选择单位类型</label>
        <div class="relative">
          <select id="unitType" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary/50 appearance-none cursor-pointer">
            <option value="length">长度</option>
            <option value="weight">重量</option>
            <option value="area">面积</option>
            <option value="volume">体积</option>
            <option value="temperature">温度</option>
            <option value="time">时间</option>
            <option value="speed">速度</option>
            <option value="density">密度</option>
            <option value="pressure">压力</option>
            <option value="data">字节</option>
            <option value="base">进制</option>
          </select>
          <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none">
            <i class="fa fa-chevron-down text-gray-400 dark:text-gray-500"></i>
          </div>
        </div>
      </div>
      
      <!-- 换算区域 -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- 输入区域 -->
        <div class="space-y-4">
          <label class="block text-gray-700 dark:text-dark-secondary font-medium">从</label>
          <div class="flex space-x-3">
            <input type="number" id="inputValue" class="flex-1 p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="输入数值">
            <select id="fromUnit" class="p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary/50 cursor-pointer">
              <!-- 选项将通过JavaScript动态填充 -->
            </select>
          </div>
        </div>
        
        <!-- 交换按钮 -->
        <div class="flex items-center justify-center">
          <button id="swapUnits" class="w-10 h-10 rounded-full bg-primary/10 text-primary flex items-center justify-center hover:bg-primary/20 transition-custom">
            <i class="fa fa-exchange"></i>
          </button>
        </div>
        
        <!-- 结果区域 -->
        <div class="space-y-4">
          <label class="block text-gray-700 dark:text-dark-secondary font-medium">到</label>
          <div class="flex space-x-3">
            <input type="text" id="outputValue" class="flex-1 p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-secondary/50" readonly>
            <select id="toUnit" class="p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-secondary/50 cursor-pointer">
              <!-- 选项将通过JavaScript动态填充 -->
            </select>
          </div>
        </div>
      </div>
      
      <!-- 转换按钮 -->
      <div class="mt-8 text-center">
        <button id="convertBtn" class="bg-primary hover:bg-primary/90 text-white font-medium py-3 px-8 rounded-lg transition-custom shadow-lg hover:shadow-xl">
          <i class="fa fa-calculator mr-2"></i>转换
        </button>
      </div>
    </div>
    
    <!-- 历史记录 -->
    <div class="bg-white dark:bg-dark-card rounded-2xl p-6 md:p-8 card-shadow">
      <h2 class="text-xl font-bold mb-4 flex items-center">
        <i class="fa fa-history text-gray-500 dark:text-dark-secondary mr-2"></i>转换历史
      </h2>
      <div id="historyList" class="space-y-3 max-h-40 overflow-y-auto pr-2">
        <p class="text-gray-500 dark:text-dark-secondary italic text-center">暂无转换记录</p>
      </div>
      <button id="clearHistory" class="mt-4 text-sm text-gray-500 dark:text-dark-secondary hover:text-red-500 dark:hover:text-red-400 transition-custom">
        <i class="fa fa-trash mr-1"></i>清除历史记录
      </button>
    </div>
    
    <!-- 页脚 -->
    <footer class="mt-10 text-center text-gray-500 dark:text-dark-secondary text-sm">
      <p>单位换算工具 &copy; 2025 | 陈省安制作</p>
    </footer>
  </div>

  <script>
    // 暗色模式切换功能
    function setupDarkMode() {
      const themeToggle = document.getElementById('themeToggle');
      const html = document.documentElement;
      
      // 检查用户偏好或本地存储的设置
      const isDarkMode = localStorage.getItem('darkMode') === 'true' || 
                         (localStorage.getItem('darkMode') === null && 
                          window.matchMedia('(prefers-color-scheme: dark)').matches);
      
      // 应用初始主题
      if (isDarkMode) {
        html.classList.add('dark');
      }
      
      // 切换主题
      themeToggle.addEventListener('click', () => {
        html.classList.toggle('dark');
        localStorage.setItem('darkMode', html.classList.contains('dark'));
      });
    }
    
    // 单位数据定义 - 为每个单位添加了英文缩写
    const unitData = {
      length: {
        units: [
          { id: 'm', name: '米 (m)' },
          { id: 'km', name: '千米 (km)' },
          { id: 'dm', name: '分米 (dm)' },
          { id: 'cm', name: '厘米 (cm)' },
          { id: 'mm', name: '毫米 (mm)' },
          { id: 'dmm', name: '丝米 (dmm)' },
          { id: 's', name: '丝(机械尺寸) (s)' },
          { id: 'μm', name: '微米 (μm)' },
          { id: 'nm', name: '纳米 (nm)' },
          { id: 'li', name: '里' },
          { id: 'zhang', name: '丈' },
          { id: 'chi', name: '尺' },
          { id: 'cun', name: '寸' },
          { id: 'fen', name: '分' },
          { id: 'li', name: '厘' },
          { id: 'hao', name: '毫' },
          { id: 'bu', name: '步' },
          { id: 'nmi', name: '海里 (nmi)' },
          { id: 'fathom', name: '英寻 (fathom)' },
          { id: 'ft', name: '英尺 (ft)' },
          { id: 'in', name: '英寸 (in)' },
          { id: 'mi', name: '英里 (mi)' },
          { id: 'fur', name: '弗隆 (fur)' },
          { id: 'yd', name: '码 (yd)' }
        ],
        // 转换为米的系数
        toBase: {
          m: 1,
          km: 1000,
          dm: 0.1,
          cm: 0.01,
          mm: 0.001,
          dmm: 0.0001,
          s: 0.00001,     // 1丝 = 0.00001米
          μm: 0.000001,   // 1微米 = 1e-6米
          nm: 0.000000001,// 1纳米 = 1e-9米
          li: 500,        // 1里 = 500米
          zhang: 10/3,    // 1丈 = 10/3 ≈ 3.3333米
          chi: 1/3,       // 1尺 = 1/3 ≈ 0.3333米
          cun: 1/30,      // 1寸 = 1/30 ≈ 0.0333米
          fen: 1/300,     // 1分 = 1/300 ≈ 0.0033米
          li: 1/3000,     // 1厘 = 1/3000 ≈ 0.00033米
          hao: 1/30000,   // 1毫 = 1/30000 ≈ 0.000033米
          bu: 0.6,        // 1步 ≈ 0.6米
          nmi: 1852,      // 1海里 = 1852米
          fathom: 1.8288, // 1英寻 = 1.8288米
          ft: 0.3048,     // 1英尺 = 0.3048米
          in: 0.0254,     // 1英寸 = 0.0254米
          mi: 1609.34,    // 1英里 = 1609.34米
          fur: 201.168,   // 1弗隆 = 201.168米
          yd: 0.9144      // 1码 = 0.9144米
        }
      },
      weight: {
        units: [
          { id: 'kg', name: '千克 (kg)' },
          { id: 'g', name: '克 (g)' },
          { id: 'mg', name: '毫克 (mg)' },
          { id: 'μg', name: '微克 (μg)' },
          { id: 't', name: '吨 (t)' },
          { id: 'lb', name: '磅 (lb)' },
          { id: 'oz', name: '盎司 (oz)' },
          { id: 'ct', name: '克拉 (ct)' },
          { id: 'gr', name: '格令 (gr)' },
          { id: 'dan', name: '担' },
          { id: 'jin', name: '斤' },
          { id: 'liang', name: '两' },
          { id: 'qian', name: '钱' },
          { id: 'cwt_uk', name: '英担 (cwt)' },
          { id: 'cwt_us', name: '美担 (cwt)' },
          { id: 'st', name: '英石 (st)' },
          { id: 'dr', name: '打兰 (dr)' }
        ],
        // 转换为千克的系数
        toBase: {
          kg: 1,
          g: 0.001,
          mg: 0.000001,
          μg: 0.000000001, // 1微克 = 1e-9千克
          t: 1000,
          lb: 0.453592,
          oz: 0.0283495,
          ct: 0.0002,      // 1克拉 = 0.0002千克
          gr: 0.00006479891,// 1格令 = 0.00006479891千克
          dan: 50,         // 1担 = 50千克
          jin: 0.5,        // 1斤 = 0.5千克
          liang: 0.05,     // 1两 = 0.05千克
          qian: 0.005,     // 1钱 = 0.005千克
          cwt_uk: 50.8023, // 1英担 = 50.8023千克
          cwt_us: 45.3592, // 1美担 = 45.3592千克
          st: 6.35029,     // 1英石 = 6.35029千克
          dr: 0.001771845  // 1打兰 = 0.001771845千克
        }
      },
      area: {
        units: [
          { id: 'm2', name: '平方米 (m²)' },
          { id: 'km2', name: '平方千米 (km²)' },
          { id: 'cm2', name: '平方厘米 (cm²)' },
          { id: 'mm2', name: '平方毫米 (mm²)' },
          { id: 'in2', name: '平方英寸 (in²)' },
          { id: 'ft2', name: '平方英尺 (ft²)' },
          { id: 'yd2', name: '平方码 (yd²)' },
          { id: 'ac', name: '英亩 (ac)' },
          { id: 'ha', name: '公顷 (ha)' },
          { id: 'mu', name: '亩' },
          { id: 'fen', name: '分' }
        ],
        // 转换为平方米的系数
        toBase: {
          m2: 1,
          km2: 1000000,
          cm2: 0.0001,
          mm2: 0.000001,
          in2: 0.00064516,
          ft2: 0.092903,
          yd2: 0.836127,
          ac: 4046.86,
          ha: 10000,      // 1公顷 = 10000平方米
          mu: 666.6667,   // 1亩 ≈ 666.6667平方米
          fen: 66.6667    // 1分 ≈ 66.6667平方米
        }
      },
      volume: {
        units: [
          { id: 'm3', name: '立方米 (m³)' },
          { id: 'l', name: '升 (L)' },
          { id: 'ml', name: '毫升 (mL)' },
          { id: 'cm3', name: '立方厘米 (cm³)' },
          { id: 'in3', name: '立方英寸 (in³)' },
          { id: 'ft3', name: '立方英尺 (ft³)' },
          { id: 'gal_us', name: '美制加仑 (gal)' },
          { id: 'gal_uk', name: '英制加仑 (gal)' },
          { id: 'dou', name: '斗' },
          { id: 'sheng', name: '升(市升)' }
        ],
        // 转换为立方米的系数
        toBase: {
          m3: 1,
          l: 0.001,
          ml: 0.000001,
          cm3: 0.000001,
          in3: 0.0000163871,
          ft3: 0.0283168,
          gal_us: 0.00378541,
          gal_uk: 0.00454609,
          dou: 0.01,     // 1斗 = 0.01立方米
          sheng: 0.001   // 1升（市升）= 0.001立方米
        }
      },
      temperature: {
        units: [
          { id: 'c', name: '摄氏度 (°C)' },
          { id: 'f', name: '华氏度 (°F)' },
          { id: 'k', name: '开尔文 (K)' }
        ],
        // 温度转换比较特殊，单独处理
        convert: function(value, from, to) {
          let celsius;
          
          // 先转换为摄氏度
          if (from === 'c') {
            celsius = value;
          } else if (from === 'f') {
            celsius = (value - 32) * 5 / 9;
          } else if (from === 'k') {
            celsius = value - 273.15;
          }
          
          // 从摄氏度转换到目标单位
          if (to === 'c') {
            return celsius;
          } else if (to === 'f') {
            return celsius * 9 / 5 + 32;
          } else if (to === 'k') {
            return celsius + 273.15;
          }
        }
      },
      time: {
        units: [
          { id: 's', name: '秒 (s)' },
          { id: 'ms', name: '毫秒 (ms)' },
          { id: 'μs', name: '微秒 (μs)' },
          { id: 'ns', name: '纳秒 (ns)' },
          { id: 'ps', name: '皮秒 (ps)' },
          { id: 'min', name: '分钟 (min)' },
          { id: 'h', name: '小时 (h)' },
          { id: 'd', name: '天 (d)' },
          { id: 'wk', name: '周 (wk)' },
          { id: 'mo', name: '月(30天) (mo)' },
          { id: 'yr', name: '年(365.25天) (yr)' },
          { id: 'shichen', name: '时辰' }
        ],
        // 转换为秒的系数
        toBase: {
          s: 1,
          ms: 0.001,               // 1毫秒 = 0.001秒
          μs: 0.000001,            // 1微秒 = 1e-6秒
          ns: 0.000000001,         // 1纳秒 = 1e-9秒
          ps: 0.000000000001,      // 1皮秒 = 1e-12秒
          min: 60,
          h: 3600,
          d: 86400,
          wk: 604800,
          mo: 2592000,             // 30天
          yr: 31557600,            // 365.25天
          shichen: 7200            // 1时辰 = 2小时 = 7200秒
        }
      },
      speed: {
        units: [
          { id: 'm_s', name: '米/秒 (m/s)' },
          { id: 'km_h', name: '千米/小时 (km/h)' },
          { id: 'miles_h', name: '英里/小时 (mph)' },
          { id: 'ft_s', name: '英尺/秒 (ft/s)' },
          { id: 'knot', name: '节 (kn)' }
        ],
        // 转换为米/秒的系数
        toBase: {
          m_s: 1,
          km_h: 0.277778,
          miles_h: 0.44704,
          ft_s: 0.3048,
          knot: 0.514444
        }
      },
      density: {
        units: [
          { id: 'kg_m3', name: '千克/立方米 (kg/m³)' },
          { id: 'g_cm3', name: '克/立方厘米 (g/cm³)' },
          { id: 'g_ml', name: '克/毫升 (g/mL)' },
          { id: 'kg_l', name: '千克/升 (kg/L)' },
          { id: 'lb_ft3', name: '磅/立方英尺 (lb/ft³)' },
          { id: 'lb_gal_us', name: '磅/美制加仑 (lb/gal)' },
          { id: 'lb_gal_uk', name: '磅/英制加仑 (lb/gal)' }
        ],
        // 转换为千克/立方米的系数
        toBase: {
          kg_m3: 1,
          g_cm3: 1000,          // 1克/立方厘米 = 1000千克/立方米
          g_ml: 1000,           // 1克/毫升 = 1000千克/立方米
          kg_l: 1000,           // 1千克/升 = 1000千克/立方米
          lb_ft3: 16.0185,      // 1磅/立方英尺 ≈ 16.0185千克/立方米
          lb_gal_us: 119.826,   // 1磅/美制加仑 ≈ 119.826千克/立方米
          lb_gal_uk: 99.7763    // 1磅/英制加仑 ≈ 99.7763千克/立方米
        }
      },
      pressure: {
        units: [
          { id: 'pa', name: '帕斯卡 (Pa)' },
          { id: 'kpa', name: '千帕 (kPa)' },
          { id: 'mpa', name: '兆帕 (MPa)' },
          { id: 'bar', name: '巴 (bar)' },
          { id: 'mbar', name: '毫巴 (mbar)' },
          { id: 'atm', name: '标准大气压 (atm)' },
          { id: 'mmhg', name: '毫米汞柱 (mmHg)' },
          { id: 'cmhg', name: '厘米汞柱 (cmHg)' },
          { id: 'psi', name: '磅力/平方英寸 (psi)' },
          { id: 'kgf_cm2', name: '千克力/平方厘米 (kgf/cm²)' }
        ],
        // 转换为帕斯卡的系数
        toBase: {
          pa: 1,
          kpa: 1000,            // 1千帕 = 1000帕
          mpa: 1000000,         // 1兆帕 = 1e6帕
          bar: 100000,          // 1巴 = 1e5帕
          mbar: 100,            // 1毫巴 = 100帕
          atm: 101325,          // 1标准大气压 ≈ 101325帕
          mmhg: 133.322,        // 1毫米汞柱 ≈ 133.322帕
          cmhg: 1333.22,        // 1厘米汞柱 ≈ 1333.22帕
          psi: 6894.76,         // 1磅力/平方英寸 ≈ 6894.76帕
          kgf_cm2: 98066.5      // 1千克力/平方厘米 ≈ 98066.5帕
        }
      },
      data: {
        units: [
          { id: 'b', name: '字节 (B)' },
          { id: 'kb', name: '千字节 (KB)' },
          { id: 'mb', name: '兆字节 (MB)' },
          { id: 'gb', name: '吉字节 (GB)' },
          { id: 'tb', name: '太字节 (TB)' },
          { id: 'pb', name: '拍字节 (PB)' },
          { id: 'eb', name: '艾字节 (EB)' },
          { id: 'bit', name: '比特 (bit)' },
          { id: 'kbit', name: '千比特 (kbit)' },
          { id: 'mbit', name: '兆比特 (Mbit)' },
          { id: 'gbit', name: '吉比特 (Gbit)' },
          { id: 'tbit', name: '太比特 (Tbit)' }
        ],
        // 转换为字节的系数
        toBase: {
          b: 1,
          kb: 1024,             // 1千字节 = 1024字节
          mb: 1024 * 1024,      // 1兆字节 = 1024^2字节
          gb: 1024 * 1024 * 1024, // 1吉字节 = 1024^3字节
          tb: Math.pow(1024, 4),// 1太字节 = 1024^4字节
          pb: Math.pow(1024, 5),// 1拍字节 = 1024^5字节
          eb: Math.pow(1024, 6),// 1艾字节 = 1024^6字节
          bit: 1/8,             // 1比特 = 1/8字节
          kbit: 1024/8,         // 1千比特 = 1024/8字节
          mbit: (1024*1024)/8,  // 1兆比特 = 1024^2/8字节
          gbit: Math.pow(1024, 3)/8, // 1吉比特 = 1024^3/8字节
          tbit: Math.pow(1024, 4)/8  // 1太比特 = 1024^4/8字节
        }
      },
      base: {
        units: [
          { id: 'bin', name: '二进制' },
          { id: 'oct', name: '八进制' },
          { id: 'dec', name: '十进制' },
          { id: 'hex', name: '十六进制' }
        ],
        // 进制转换特殊处理
        convert: function(value, from, to) {
          // 先将输入值转换为十进制
          let decimal;
          switch(from) {
            case 'bin':
              decimal = parseInt(value, 2);
              break;
            case 'oct':
              decimal = parseInt(value, 8);
              break;
            case 'dec':
              decimal = parseInt(value, 10);
              break;
            case 'hex':
              decimal = parseInt(value, 16);
              break;
            default:
              return NaN;
          }
          
          // 检查是否为有效数字
          if (isNaN(decimal)) return NaN;
          
          // 转换为目标进制
          switch(to) {
            case 'bin':
              return decimal.toString(2);
            case 'oct':
              return decimal.toString(8);
            case 'dec':
              return decimal.toString(10);
            case 'hex':
              return decimal.toString(16).toUpperCase();
            default:
              return NaN;
          }
        }
      }
    };
    
    // DOM元素获取
    const unitTypeSelect = document.getElementById('unitType');
    const fromUnitSelect = document.getElementById('fromUnit');
    const toUnitSelect = document.getElementById('toUnit');
    const inputValue = document.getElementById('inputValue');
    const outputValue = document.getElementById('outputValue');
    const convertBtn = document.getElementById('convertBtn');
    const swapBtn = document.getElementById('swapUnits');
    const historyList = document.getElementById('historyList');
    const clearHistoryBtn = document.getElementById('clearHistory');
    
    // 初始化单位选择器
    function initUnitSelectors() {
      const selectedType = unitTypeSelect.value;
      const units = unitData[selectedType].units;
      
      // 清空现有选项
      fromUnitSelect.innerHTML = '';
      toUnitSelect.innerHTML = '';
      
      // 添加新选项
      units.forEach(unit => {
        const fromOption = document.createElement('option');
        fromOption.value = unit.id;
        fromOption.textContent = unit.name;
        fromUnitSelect.appendChild(fromOption);
        
        const toOption = document.createElement('option');
        toOption.value = unit.id;
        toOption.textContent = unit.name;
        toUnitSelect.appendChild(toOption);
      });
      
      // 默认选择不同的单位
      if (units.length > 1) {
        toUnitSelect.selectedIndex = 1;
      }
      
      // 对于进制转换，输入框需要特殊处理
      if (selectedType === 'base') {
        inputValue.type = 'text';
        inputValue.placeholder = '输入数值（如1010、A3）';
      } else {
        inputValue.type = 'number';
        inputValue.placeholder = '输入数值';
      }
    }
    
    // 格式化输出结果：如果是整数则去除小数点，否则保留最多6位小数
    function formatResult(result, unitType) {
      // 进制转换结果不需要格式化
      if (unitType === 'base') {
        return result;
      }
      
      // 检查是否为数字
      if (isNaN(result)) {
        return '无效输入';
      }
      
      // 检查是否为整数
      if (Math.abs(result - Math.round(result)) < 1e-6) {
        return Math.round(result).toString();
      }
      
      // 否则保留最多6位小数，去除末尾的0
      return result.toFixed(6).replace(/\.?0+$/, '');
    }
    
    // 转换单位
    function convertUnit() {
      const inputVal = inputValue.value.trim();
      if (!inputVal) {
        alert('请输入数值');
        return;
      }
      
      const unitType = unitTypeSelect.value;
      const fromUnit = fromUnitSelect.value;
      const toUnit = toUnitSelect.value;
      
      let result;
      
      // 特殊处理温度和进制转换
      if (unitType === 'temperature') {
        const value = parseFloat(inputVal);
        if (isNaN(value)) {
          alert('请输入有效的数值');
          return;
        }
        result = unitData.temperature.convert(value, fromUnit, toUnit);
      } else if (unitType === 'base') {
        // 进制转换输入是文本
        result = unitData.base.convert(inputVal, fromUnit, toUnit);
      } else {
        // 其他类型转换：先转换为基本单位，再转换为目标单位
        const value = parseFloat(inputVal);
        if (isNaN(value)) {
          alert('请输入有效的数值');
          return;
        }
        const toBase = unitData[unitType].toBase;
        const baseValue = value * toBase[fromUnit];
        result = baseValue / toBase[toUnit];
      }
      
      // 格式化结果并显示
      outputValue.value = formatResult(result, unitType);
      
      // 添加到历史记录
      addToHistory(inputVal, fromUnit, result, toUnit, unitType);
    }
    
    // 添加到历史记录
    function addToHistory(inputVal, fromUnit, outputVal, toUnit, unitType) {
      // 获取单位名称
      const fromUnitName = unitData[unitType].units.find(u => u.id === fromUnit).name;
      const toUnitName = unitData[unitType].units.find(u => u.id === toUnit).name;
      
      // 格式化显示值
      const formattedInput = unitType === 'base' ? inputVal : formatResult(parseFloat(inputVal), unitType);
      const formattedOutput = formatResult(outputVal, unitType);
      
      // 创建历史记录项
      const historyItem = document.createElement('div');
      historyItem.className = 'p-2 bg-gray-50 dark:bg-gray-700 rounded-lg flex justify-between items-center';
      historyItem.innerHTML = `
        <span>${formattedInput} ${fromUnitName} = ${formattedOutput} ${toUnitName}</span>
        <span class="text-xs text-gray-400 dark:text-gray-500">${new Date().toLocaleTimeString()}</span>
      `;
      
      // 如果是第一条记录，先清空"暂无记录"提示
      if (historyList.querySelector('p.italic')) {
        historyList.innerHTML = '';
      }
      
      // 添加到历史记录列表顶部
      historyList.insertBefore(historyItem, historyList.firstChild);
      
      // 限制历史记录数量为10条
      if (historyList.children.length > 10) {
        historyList.removeChild(historyList.lastChild);
      }
    }
    
    // 交换单位
    function swapUnits() {
      const tempUnit = fromUnitSelect.value;
      fromUnitSelect.value = toUnitSelect.value;
      toUnitSelect.value = tempUnit;
      
      // 如果有输入值，立即转换
      if (inputValue.value) {
        convertUnit();
      }
    }
    
    // 清除历史记录
    function clearHistory() {
      historyList.innerHTML = '<p class="text-gray-500 dark:text-dark-secondary italic text-center">暂无转换记录</p>';
    }
    
    // 初始化
    function init() {
      setupDarkMode();
      initUnitSelectors();
      
      // 事件监听
      unitTypeSelect.addEventListener('change', initUnitSelectors);
      convertBtn.addEventListener('click', convertUnit);
      swapBtn.addEventListener('click', swapUnits);
      clearHistoryBtn.addEventListener('click', clearHistory);
      
      // 输入框回车触发转换
      inputValue.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          convertUnit();
        }
      });
      
      // 单位选择变化时自动转换
      fromUnitSelect.addEventListener('change', function() {
        if (inputValue.value) convertUnit();
      });
      
      toUnitSelect.addEventListener('change', function() {
        if (inputValue.value) convertUnit();
      });
    }
    
    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
