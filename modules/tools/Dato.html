<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据可视化工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- 添加jsPDF库用于PDF导出 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- 配置Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#FF7D00',
                        neutral: '#F5F7FA',
                        dark: '#1D2129',
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }
            .hover-scale {
                transition: transform 0.3s ease;
            }
            .hover-scale:hover {
                transform: scale(1.02);
            }
            .progress-bar {
                transition: width 0.5s ease;
            }
            .drop-active {
                border-color: #165DFF !important;
                background-color: rgba(22, 93, 255, 0.05) !important;
            }
            .size-option-active {
                background-color: #165DFF !important;
                color: white !important;
                border-color: #165DFF !important;
            }
            .export-progress-backdrop {
                backdrop-filter: blur(3px);
                -webkit-backdrop-filter: blur(3px);
            }
        }
    </style>
</head>
<body class="font-inter bg-gray-50 text-dark min-h-screen flex flex-col">
    <!-- 导航栏 -->
    <nav class="bg-white shadow-sm sticky top-0 z-50 transition-all duration-300" id="navbar">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center">
                        <i class="fa-solid fa-chart-line text-primary text-2xl mr-2"></i>
                        <span class="text-xl font-semibold">Dato</span>
                    </div>
                    <div class="hidden sm:ml-6 sm:flex space-x-8">
                        <a href="#upload" class="text-gray-700 hover:text-primary px-3 py-2 text-sm font-medium transition-colors duration-200">上传数据</a>
                        <a href="#visualize" class="text-gray-700 hover:text-primary px-3 py-2 text-sm font-medium transition-colors duration-200">可视化</a>
                        <a href="#settings" class="text-gray-700 hover:text-primary px-3 py-2 text-sm font-medium transition-colors duration-200">导出</a>
                    </div>
                </div>
                <div class="flex items-center">
                    <button class="p-2 rounded-md text-gray-500 hover:text-primary focus:outline-none">
                        <i class="fa-solid fa-question-circle"></i>
                    </button>
                    <button class="ml-4 p-2 rounded-md text-gray-500 hover:text-primary focus:outline-none">
                        <i class="fa-solid fa-user-circle"></i>
                    </button>
                    <button class="ml-4 block px-4 py-2 rounded-md text-white bg-primary hover:bg-primary/90 transition-colors duration-200 shadow-sm">
                        <i class="fa-solid fa-download mr-1"></i> 导出
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主内容区 -->
    <main class="flex-grow container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- 欢迎信息 -->
        <section class="mb-10">
            <h1 class="text-[clamp(1.75rem,3vw,2.5rem)] font-bold text-gray-900 mb-2">数据可视化工具</h1>
            <p class="text-gray-600 max-w-3xl">上传您的Excel或CSV文件，快速生成交互式图表和可视化报表，支持多数据对比分析，帮助您更好地理解和展示数据。</p>
        </section>

        <!-- 上传区域 -->
        <section id="upload" class="mb-12">
            <div class="bg-white rounded-xl p-6 shadow-lg hover:shadow-xl transition-shadow duration-300">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fa-solid fa-cloud-upload text-primary mr-2"></i> 上传数据
                </h2>
                
                <div id="drop-area" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-primary transition-colors duration-200 cursor-pointer mb-6">
                    <input type="file" id="file-input" class="hidden" accept=".xlsx,.xls,.csv">
                    <i class="fa-solid fa-file-excel text-5xl text-gray-400 mb-4"></i>
                    <p class="text-gray-500 mb-2">拖放文件到此处，或</p>
                    <button id="browse-btn" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/90 transition-colors duration-200 shadow-sm">
                        <i class="fa-solid fa-folder-open mr-1"></i> 浏览文件
                    </button>
                    <p class="text-gray-400 text-sm mt-4">支持 .xlsx, .xls, .csv 格式</p>
                </div>
                
                <!-- 上传进度条 -->
                <div id="upload-progress" class="hidden mb-4">
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-sm text-gray-600">上传进度</span>
                        <span id="progress-percentage" class="text-sm font-medium text-primary">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="progress-bar" class="bg-primary h-2 rounded-full progress-bar" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- 文件信息 -->
                <div id="file-info" class="hidden mb-6">
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                        <div class="flex items-center">
                            <i class="fa-solid fa-file-excel text-primary mr-3 text-xl"></i>
                            <div>
                                <p id="file-name" class="font-medium text-gray-900 truncate max-w-xs"></p>
                                <p id="file-size" class="text-sm text-gray-500"></p>
                            </div>
                        </div>
                        <button id="remove-file" class="text-gray-400 hover:text-red-500 transition-colors duration-200">
                            <i class="fa-solid fa-times-circle"></i>
                        </button>
                    </div>
                </div>
                
                <!-- 数据预览 -->
                <div id="data-preview" class="hidden mt-6">
                    <h3 class="text-lg font-medium mb-3">数据预览</h3>
                    <div class="overflow-x-auto bg-gray-50 rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead id="table-header" class="bg-gray-100"></thead>
                            <tbody id="table-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- 可视化区域 -->
        <section id="visualize" class="mb-12">
            <div class="bg-white rounded-xl p-6 shadow-lg hover:shadow-xl transition-shadow duration-300">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fa-solid fa-chart-pie text-primary mr-2"></i> 可视化设置
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- 图表类型选择 -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="font-medium mb-3">图表类型</h3>
                        <div class="space-y-2" id="chart-types">
                            <div class="flex items-center p-2 rounded hover:bg-gray-100 cursor-pointer transition-colors duration-200 chart-type-option" data-type="bar">
                                <i class="fa-solid fa-chart-bar text-primary mr-2"></i>
                                <span>柱状图</span>
                            </div>
                            <div class="flex items-center p-2 rounded hover:bg-gray-100 cursor-pointer transition-colors duration-200 chart-type-option" data-type="line">
                                <i class="fa-solid fa-chart-line text-primary mr-2"></i>
                                <span>折线图</span>
                            </div>
                            <div class="flex items-center p-2 rounded hover:bg-gray-100 cursor-pointer transition-colors duration-200 chart-type-option" data-type="pie">
                                <i class="fa-solid fa-chart-pie text-primary mr-2"></i>
                                <span>饼图</span>
                            </div>
                            <div class="flex items-center p-2 rounded hover:bg-gray-100 cursor-pointer transition-colors duration-200 chart-type-option" data-type="doughnut">
                                <i class="fa-solid fa-doughnut text-primary mr-2"></i>
                                <span>环形图</span>
                            </div>
                            <div class="flex items-center p-2 rounded hover:bg-gray-100 cursor-pointer transition-colors duration-200 chart-type-option" data-type="radar">
                                <i class="fa-solid fa-radar text-primary mr-2"></i>
                                <span>雷达图</span>
                            </div>
                        </div>
                        <div class="mt-4 text-sm text-gray-500 p-2 bg-blue-50 rounded-md">
                            <i class="fa-info-circle text-primary mr-1"></i> 
                            <span>柱状图和折线图支持多数据系列对比</span>
                        </div>
                    </div>
                    
                    <!-- 数据列选择 -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="font-medium mb-3">数据列</h3>
                        <div id="column-selectors" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">X轴/类别</label>
                                <select id="x-axis-select" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary/50 focus:border-primary transition-colors duration-200">
                                    <option value="">请选择...</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Y轴/数值系列</label>
                                <div id="y-axis-selectors">
                                    <div class="y-axis-selector flex mb-2">
                                        <select class="flex-grow p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary/50 focus:border-primary transition-colors duration-200 mr-2">
                                            <option value="">请选择...</option>
                                        </select>
                                        <button type="button" class="remove-y-axis p-2 text-gray-400 hover:text-red-500 transition-colors duration-200">
                                            <i class="fa-solid fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                                <button type="button" id="add-y-axis" class="mt-2 px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors duration-200">
                                    <i class="fa-solid fa-plus mr-1"></i> 添加数据系列
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 图表选项 -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="font-medium mb-3">图表选项</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">图表标题</label>
                                <input type="text" id="chart-title" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary/50 focus:border-primary transition-colors duration-200" placeholder="请输入图表标题">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">颜色主题</label>
                                <div class="grid grid-cols-3 gap-2">
                                    <button class="theme-btn h-8 rounded-md bg-blue-500" data-theme="blue"></button>
                                    <button class="theme-btn h-8 rounded-md bg-green-500" data-theme="green"></button>
                                    <button class="theme-btn h-8 rounded-md bg-purple-500" data-theme="purple"></button>
                                    <button class="theme-btn h-8 rounded-md bg-red-500" data-theme="red"></button>
                                    <button class="theme-btn h-8 rounded-md bg-yellow-500" data-theme="yellow"></button>
                                    <button class="theme-btn h-8 rounded-md bg-gray-500" data-theme="gray"></button>
                                </div>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="show-legend" class="h-4 w-4 text-primary focus:ring-primary/50 border-gray-300 rounded" checked>
                                <label for="show-legend" class="ml-2 block text-sm text-gray-700">显示图例</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="show-grid" class="h-4 w-4 text-primary focus:ring-primary/50 border-gray-300 rounded">
                                <label for="show-grid" class="ml-2 block text-sm text-gray-700">显示网格线</label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button id="generate-chart" class="mt-6 px-6 py-3 bg-primary text-white rounded-md hover:bg-primary/90 transition-colors duration-200 shadow-sm flex items-center">
                    <i class="fa-solid fa-refresh mr-2"></i> 生成图表
                </button>
            </div>
        </section>

        <!-- 图表展示区域 -->
        <section class="mb-12">
            <div class="bg-white rounded-xl p-6 shadow-lg hover:shadow-xl transition-shadow duration-300">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fa-solid fa-chart-area text-primary mr-2"></i> 图表展示
                </h2>
                
                <div id="chart-container" class="hidden relative h-96">
                    <canvas id="chart-canvas"></canvas>
                </div>
                
                <div id="no-chart-message" class="h-96 flex items-center justify-center text-gray-400">
                    <div class="text-center">
                        <i class="fa-solid fa-chart-line text-5xl mb-4"></i>
                        <p>上传数据并生成图表后将在此处显示</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- 导出设置 -->
        <section id="settings" class="mb-12">
            <div class="bg-white rounded-xl p-6 shadow-lg hover:shadow-xl transition-shadow duration-300">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fa-solid fa-download text-primary mr-2"></i> 导出设置
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- 导出格式 -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="font-medium mb-3">导出格式</h3>
                        <div class="space-y-2">
                            <div class="flex items-center p-2 rounded hover:bg-gray-100 cursor-pointer transition-colors duration-200 export-option" data-format="png">
                                <i class="fa-solid fa-file-image text-primary mr-2"></i>
                                <span>PNG 图片</span>
                            </div>
                            <div class="flex items-center p-2 rounded hover:bg-gray-100 cursor-pointer transition-colors duration-200 export-option" data-format="jpg">
                                <i class="fa-solid fa-file-image text-primary mr-2"></i>
                                <span>JPG 图片</span>
                            </div>
                            <div class="flex items-center p-2 rounded hover:bg-gray-100 cursor-pointer transition-colors duration-200 export-option" data-format="svg">
                                <i class="fa-solid fa-file-code text-primary mr-2"></i>
                                <span>SVG 矢量图（暂未开发）</span>
                            </div>
                            <div class="flex items-center p-2 rounded hover:bg-gray-100 cursor-pointer transition-colors duration-200 export-option" data-format="pdf">
                                <i class="fa-solid fa-file-pdf text-primary mr-2"></i>
                                <span>PDF 文件</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 导出选项 -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="font-medium mb-3">导出选项</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">文件名</label>
                                <input type="text" id="export-filename" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary/50 focus:border-primary transition-colors duration-200" value="data-visualization">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">图片尺寸</label>
                                <div class="flex space-x-3">
                                    <button type="button" class="size-option flex-1 py-2 border border-gray-300 rounded-md hover:bg-gray-100 transition-colors duration-200" data-size="small">
                                        <span>小</span>
                                        <span class="block text-xs text-gray-500 mt-1">约 600px</span>
                                    </button>
                                    <button type="button" class="size-option flex-1 py-2 border border-gray-300 rounded-md hover:bg-gray-100 transition-colors duration-200 size-option-active" data-size="medium">
                                        <span>中</span>
                                        <span class="block text-xs text-gray-500 mt-1">约 1000px</span>
                                    </button>
                                    <button type="button" class="size-option flex-1 py-2 border border-gray-300 rounded-md hover:bg-gray-100 transition-colors duration-200" data-size="large">
                                        <span>大</span>
                                        <span class="block text-xs text-gray-500 mt-1">约 1600px</span>
                                    </button>
                                </div>
                                <p class="text-xs text-gray-500 mt-2">提示：大尺寸会生成更高清晰度的图像</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">背景</label>
                                <div class="flex items-center">
                                    <input type="radio" id="bg-transparent" name="background" class="h-4 w-4 text-primary focus:ring-primary/50 border-gray-300" checked>
                                    <label for="bg-transparent" class="ml-2 block text-sm text-gray-700">透明</label>
                                </div>
                                <div class="flex items-center mt-1">
                                    <input type="radio" id="bg-white" name="background" class="h-4 w-4 text-primary focus:ring-primary/50 border-gray-300">
                                    <label for="bg-white" class="ml-2 block text-sm text-gray-700">白色</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button id="export-chart" class="mt-6 px-6 py-3 bg-secondary text-white rounded-md hover:bg-secondary/90 transition-colors duration-200 shadow-sm flex items-center">
                    <i class="fa-solid fa-download mr-2"></i> 导出图表
                </button>
            </div>
        </section>
    </main>

    <!-- 页脚 -->
    <footer class="bg-white border-t border-gray-200">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <div class="flex items-center">
                        <i class="fa-solid fa-chart-line text-primary text-xl mr-2"></i>
                        <span class="text-lg font-semibold">Dato</span>
                    </div>
                    <p class="text-gray-500 text-sm mt-1">Date to photo | 简单易用的数据可视化工具</p>
                </div>
                
                <div class="flex space-x-6">
                    <a href="#" class="text-gray-500 hover:text-primary transition-colors duration-200">
                        <i class="fa-brands fa-github text-xl"></i>
                    </a>
                    <a href="#" class="text-gray-500 hover:text-primary transition-colors duration-200">
                        <i class="fa-brands fa-twitter text-xl"></i>
                    </a>
                    <a href="#" class="text-gray-500 hover:text-primary transition-colors duration-200">
                        <i class="fa-brands fa-linkedin text-xl"></i>
                    </a>
                </div>
            </div>
            
            <div class="mt-8 pt-8 border-t border-gray-200 flex flex-col md:flex-row justify-between items-center">
                <p class="text-gray-500 text-sm">© 2025 | Dato | 保留所有权利 | 陈省安制作</p>
                
                <div class="mt-4 md:mt-0 flex space-x-6">
                    <a href="#" class="text-gray-500 hover:text-primary text-sm transition-colors duration-200">隐私政策</a>
                    <a href="#" class="text-gray-500 hover:text-primary text-sm transition-colors duration-200">使用条款</a>
                    <a href="#" class="text-gray-500 hover:text-primary text-sm transition-colors duration-200">联系我们</a>
                </div>
            </div>
        </div>
    </footer>

    <!-- 通知组件 -->
    <div id="notification" class="fixed top-4 right-4 p-4 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full opacity-0 z-50 flex items-center">
        <i id="notification-icon" class="mr-2"></i>
        <span id="notification-message"></span>
        <button id="close-notification" class="ml-4 text-gray-400 hover:text-gray-600">
            <i class="fa-solid fa-times"></i>
        </button>
    </div>

    <!-- SVG导出进度条 -->
    <div id="export-progress" class="fixed inset-0 bg-black/50 export-progress-backdrop flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-6 w-full max-w-md shadow-2xl transform transition-all">
            <h3 class="text-lg font-semibold mb-4 text-center">正在导出...</h3>
            <div class="mb-2">
                <div class="flex justify-between text-sm mb-1">
                    <span id="export-progress-text">准备中</span>
                    <span id="export-progress-percentage">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="export-progress-bar" class="bg-primary h-2.5 rounded-full progress-bar" style="width: 0%"></div>
                </div>
            </div>
            <p id="export-progress-detail" class="text-sm text-gray-500 text-center mt-2">请稍候，正在处理您的图表...</p>
        </div>
    </div>

    <script>
        // 确保DOM完全加载后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 全局变量
            let data = null;
            let chart = null;
            let chartConfig = null; // 保存图表配置，用于重新渲染高分辨率版本
            let selectedTheme = 'blue';
            let fileReader = null; // 用于处理文件读取的全局变量
            let chartAspectRatio = 4/3; // 默认宽高比 4:3
            let selectedSize = 'medium'; // 默认选中中等尺寸
            let temporaryCharts = []; // 用于跟踪临时创建的图表，以便清理
            
            // 尺寸规格定义（以宽度为基准，高度将根据比例自动计算）
            const sizeSpecs = {
                small: 600,
                medium: 1000,
                large: 1600
            };
            
            // DOM 元素
            const dropArea = document.getElementById('drop-area');
            const fileInput = document.getElementById('file-input');
            const browseBtn = document.getElementById('browse-btn');
            const uploadProgress = document.getElementById('upload-progress');
            const progressBar = document.getElementById('progress-bar');
            const progressPercentage = document.getElementById('progress-percentage');
            const fileInfo = document.getElementById('file-info');
            const fileName = document.getElementById('file-name');
            const fileSize = document.getElementById('file-size');
            const removeFile = document.getElementById('remove-file');
            const dataPreview = document.getElementById('data-preview');
            const tableHeader = document.getElementById('table-header');
            const tableBody = document.getElementById('table-body');
            const xAxisSelect = document.getElementById('x-axis-select');
            const yAxisSelectors = document.getElementById('y-axis-selectors');
            const addYAxisBtn = document.getElementById('add-y-axis');
            const chartTitle = document.getElementById('chart-title');
            const showLegend = document.getElementById('show-legend');
            const showGrid = document.getElementById('show-grid');
            const generateChart = document.getElementById('generate-chart');
            const chartContainer = document.getElementById('chart-container');
            const chartCanvas = document.getElementById('chart-canvas');
            const noChartMessage = document.getElementById('no-chart-message');
            const exportChart = document.getElementById('export-chart');
            const exportFilename = document.getElementById('export-filename');
            const bgTransparent = document.getElementById('bg-transparent');
            const bgWhite = document.getElementById('bg-white');
            const navbar = document.getElementById('navbar');
            const notification = document.getElementById('notification');
            const notificationMessage = document.getElementById('notification-message');
            const notificationIcon = document.getElementById('notification-icon');
            const closeNotification = document.getElementById('close-notification');
            
            // 导出进度条元素
            const exportProgress = document.getElementById('export-progress');
            const exportProgressBar = document.getElementById('export-progress-bar');
            const exportProgressPercentage = document.getElementById('export-progress-percentage');
            const exportProgressText = document.getElementById('export-progress-text');
            const exportProgressDetail = document.getElementById('export-progress-detail');
            
            // 更新导出进度
            function updateExportProgress(percent, text, detail = '') {
                percent = Math.max(0, Math.min(100, percent));
                exportProgressBar.style.width = `${percent}%`;
                exportProgressPercentage.textContent = `${percent}%`;
                exportProgressText.textContent = text;
                if (detail) {
                    exportProgressDetail.textContent = detail;
                }
            }
            
            // 显示导出进度条
            function showExportProgress() {
                exportProgress.classList.remove('hidden');
                updateExportProgress(0, '准备中', '初始化导出过程...');
            }
            
            // 隐藏导出进度条
            function hideExportProgress() {
                exportProgress.classList.add('hidden');
            }
            
            // 清理临时图表资源
            function cleanupTemporaryCharts() {
                temporaryCharts.forEach(tempChart => {
                    if (tempChart && typeof tempChart.destroy === 'function') {
                        tempChart.destroy();
                    }
                });
                temporaryCharts = [];
            }
            
            // 尺寸选项点击事件
            document.querySelectorAll('.size-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.size-option').forEach(opt => {
                        opt.classList.remove('size-option-active');
                    });
                    
                    this.classList.add('size-option-active');
                    selectedSize = this.dataset.size;
                });
            });
            
            // 导航栏滚动效果
            window.addEventListener('scroll', () => {
                if (window.scrollY > 10) {
                    navbar.classList.add('shadow-md', 'bg-white/95', 'backdrop-blur-sm');
                } else {
                    navbar.classList.remove('shadow-md', 'bg-white/95', 'backdrop-blur-sm');
                }
            });
            
            // 文件上传相关
            browseBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                e.preventDefault();
                fileInput.click();
            }, true);
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files && e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                } else {
                    showNotification('信息', '未选择文件', 'info');
                }
            });
            
            // 拖放功能
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            dropArea.addEventListener('dragenter', function() {
                this.classList.add('drop-active');
                showNotification('提示', '松开鼠标上传文件', 'info');
            }, false);
            
            dropArea.addEventListener('dragleave', function() {
                this.classList.remove('drop-active');
            }, false);
            
            dropArea.addEventListener('dragover', function() {
                this.classList.add('drop-active');
            }, false);
            
            dropArea.addEventListener('drop', function() {
                this.classList.remove('drop-active');
            }, false);
            
            dropArea.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                if (dt && dt.files && dt.files.length > 0) {
                    handleFile(dt.files[0]);
                } else {
                    showNotification('信息', '未检测到文件', 'info');
                }
            }
            
            dropArea.addEventListener('click', (e) => {
                if (e.target === dropArea || e.target.tagName === 'I' || e.target.tagName === 'P' && e.target.parentNode === dropArea) {
                    fileInput.click();
                }
            }, true);
            
            // 处理文件上传
            function handleFile(file) {
                console.log('处理文件:', file);
                
                if (fileReader) {
                    fileReader.abort();
                }
                
                uploadProgress.classList.remove('hidden');
                progressBar.style.width = '0%';
                progressPercentage.textContent = '0%';
                
                const fileName = file.name.toLowerCase();
                const isExcel = fileName.endsWith('.xlsx') || fileName.endsWith('.xls');
                const isCsv = fileName.endsWith('.csv');
                
                if (!isExcel && !isCsv) {
                    showNotification('错误', '请上传Excel(.xlsx, .xls)或CSV(.csv)文件', 'error');
                    uploadProgress.classList.add('hidden');
                    return;
                }
                
                fileName.textContent = file.name;
                fileSize.textContent = formatFileSize(file.size);
                fileInfo.classList.remove('hidden');
                
                fileReader = new FileReader();
                
                fileReader.onprogress = function(e) {
                    if (e.lengthComputable) {
                        const progress = (e.loaded / e.total) * 100;
                        progressBar.style.width = `${progress}%`;
                        progressPercentage.textContent = `${Math.round(progress)}%`;
                    }
                };
                
                fileReader.onloadstart = function() {
                    showNotification('信息', '开始读取文件...', 'info');
                };
                
                fileReader.onload = function(e) {
                    try {
                        if (isExcel) {
                            const workbook = XLSX.read(e.target.result, { type: 'binary' });
                            const firstSheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[firstSheetName];
                            data = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        } else if (isCsv) {
                            const text = e.target.result;
                            const lines = text.split('\n').map(line => line.trim()).filter(line => line);
                            data = [];
                            
                            lines.forEach(line => {
                                if (line.includes('"')) {
                                    const parts = [];
                                    let inQuotes = false;
                                    let currentPart = '';
                                    
                                    for (let i = 0; i < line.length; i++) {
                                        const char = line[i];
                                        if (char === '"') {
                                            inQuotes = !inQuotes;
                                        } else if (char === ',' && !inQuotes) {
                                            parts.push(currentPart);
                                            currentPart = '';
                                        } else {
                                            currentPart += char;
                                        }
                                    }
                                    
                                    parts.push(currentPart);
                                    data.push(parts);
                                } else {
                                    data.push(line.split(','));
                                }
                            });
                        }
                        
                        if (!data || data.length <= 1) {
                            showNotification('错误', '文件中没有足够的数据或文件格式不正确', 'error');
                            uploadProgress.classList.add('hidden');
                            return;
                        }
                        
                        dataPreview.classList.remove('hidden');
                        populateTablePreview();
                        populateColumnSelectors();
                        uploadProgress.classList.add('hidden');
                        
                        showNotification('成功', '文件上传并解析成功', 'success');
                    } catch (error) {
                        console.error('处理文件时出错:', error);
                        showNotification('错误', `处理文件时出错: ${error.message}`, 'error');
                        uploadProgress.classList.add('hidden');
                    }
                };
                
                fileReader.onerror = function(error) {
                    console.error('文件读取错误:', error);
                    showNotification('错误', `读取文件时出错: ${error.message}`, 'error');
                    uploadProgress.classList.add('hidden');
                };
                
                fileReader.onabort = function() {
                    showNotification('信息', '文件读取已中止', 'info');
                    uploadProgress.classList.add('hidden');
                };
                
                if (isExcel) {
                    fileReader.readAsBinaryString(file);
                } else {
                    fileReader.readAsText(file);
                }
            }
            
            // 格式化文件大小
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            // 填充表格预览
            function populateTablePreview() {
                tableHeader.innerHTML = '';
                tableBody.innerHTML = '';
                
                if (!data || data.length === 0) return;
                
                const headerRow = document.createElement('tr');
                data[0].forEach(header => {
                    const th = document.createElement('th');
                    th.textContent = header;
                    th.className = 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
                    headerRow.appendChild(th);
                });
                tableHeader.appendChild(headerRow);
                
                const rowsToDisplay = Math.min(data.length - 1, 10);
                for (let i = 1; i <= rowsToDisplay; i++) {
                    const row = document.createElement('tr');
                    row.className = i % 2 === 0 ? 'bg-gray-50' : 'bg-white';
                    
                    data[i].forEach((cell, index) => {
                        const td = document.createElement('td');
                        td.textContent = cell;
                        td.className = 'px-4 py-3 whitespace-nowrap text-sm text-gray-500';
                        row.appendChild(td);
                    });
                    
                    tableBody.appendChild(row);
                }
                
                if (data.length > 11) {
                    const moreRow = document.createElement('tr');
                    const moreTd = document.createElement('td');
                    moreTd.colSpan = data[0].length;
                    moreTd.className = 'px-4 py-3 text-center text-sm text-gray-400';
                    moreTd.textContent = `... 和 ${data.length - 10} 更多行`;
                    moreRow.appendChild(moreTd);
                    tableBody.appendChild(moreRow);
                }
            }
            
            // 填充列选择器
            function populateColumnSelectors() {
                if (!data || data.length === 0) return;
                
                xAxisSelect.innerHTML = '<option value="">请选择...</option>';
                
                data[0].forEach((column, index) => {
                    const xOption = document.createElement('option');
                    xOption.value = index;
                    xOption.textContent = column;
                    xAxisSelect.appendChild(xOption);
                });
                
                document.querySelectorAll('#y-axis-selectors .y-axis-selector select').forEach(select => {
                    select.innerHTML = '<option value="">请选择...</option>';
                    data[0].forEach((column, index) => {
                        const option = document.createElement('option');
                        option.value = index;
                        option.textContent = column;
                        select.appendChild(option);
                    });
                });
            }
            
            // 移除文件
            removeFile.addEventListener('click', () => {
                fileInput.value = '';
                if (fileReader) {
                    fileReader.abort();
                    fileReader = null;
                }
                data = null;
                chartConfig = null;
                fileInfo.classList.add('hidden');
                dataPreview.classList.add('hidden');
                
                xAxisSelect.innerHTML = '<option value="">请选择...</option>';
                resetYAxisSelectors();
                
                if (chart) {
                    chart.destroy();
                    chart = null;
                }
                cleanupTemporaryCharts();
                
                chartContainer.classList.add('hidden');
                noChartMessage.classList.remove('hidden');
                
                showNotification('信息', '文件已移除', 'info');
            });
            
            // 添加新的Y轴选择器
            addYAxisBtn.addEventListener('click', () => {
                const selectorCount = document.querySelectorAll('#y-axis-selectors .y-axis-selector').length;
                
                if (selectorCount >= 5) {
                    showNotification('提示', '最多只能添加5个数据系列', 'info');
                    return;
                }
                
                addYAxisSelector();
            });
            
            // 添加Y轴选择器
            function addYAxisSelector() {
                const selectorDiv = document.createElement('div');
                selectorDiv.className = 'y-axis-selector flex mb-2';
                
                const select = document.createElement('select');
                select.className = 'flex-grow p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary/50 focus:border-primary transition-colors duration-200 mr-2';
                select.innerHTML = '<option value="">请选择...</option>';
                
                if (data && data[0]) {
                    data[0].forEach((column, index) => {
                        const option = document.createElement('option');
                        option.value = index;
                        option.textContent = column;
                        select.appendChild(option);
                    });
                }
                
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'remove-y-axis p-2 text-gray-400 hover:text-red-500 transition-colors duration-200';
                removeBtn.innerHTML = '<i class="fa-solid fa-times"></i>';
                
                removeBtn.addEventListener('click', function() {
                    if (document.querySelectorAll('#y-axis-selectors .y-axis-selector').length > 1) {
                        selectorDiv.remove();
                    } else {
                        showNotification('提示', '至少需要保留一个数据系列', 'info');
                    }
                });
                
                selectorDiv.appendChild(select);
                selectorDiv.appendChild(removeBtn);
                yAxisSelectors.appendChild(selectorDiv);
            }
            
            // 重置Y轴选择器
            function resetYAxisSelectors() {
                yAxisSelectors.innerHTML = '';
                addYAxisSelector();
            }
            
            // 初始化第一个Y轴选择器的删除按钮事件
            document.querySelector('.remove-y-axis').addEventListener('click', function() {
                showNotification('提示', '至少需要保留一个数据系列', 'info');
            });
            
            // 默认选中第一个图表类型
            document.querySelector('.chart-type-option').classList.add('bg-primary/10', 'text-primary');
            
            // 默认选中第一个颜色主题
            document.querySelector('.theme-btn').classList.add('ring-2', 'ring-offset-2', 'ring-primary');
            
            // 默认选中第一个导出选项
            document.querySelector('.export-option').classList.add('bg-primary/10', 'text-primary');
            
            // 图表类型选择
            document.querySelectorAll('.chart-type-option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('.chart-type-option').forEach(opt => {
                        opt.classList.remove('bg-primary/10', 'text-primary');
                    });
                    
                    option.classList.add('bg-primary/10', 'text-primary');
                    
                    const chartType = option.dataset.type;
                    const ySelectors = document.querySelectorAll('#y-axis-selectors .y-axis-selector');
                    
                    if (chartType === 'pie' || chartType === 'doughnut' || chartType === 'radar') {
                        while (ySelectors.length > 1) {
                            ySelectors[ySelectors.length - 1].remove();
                        }
                        addYAxisBtn.disabled = true;
                        addYAxisBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    } else {
                        addYAxisBtn.disabled = false;
                        addYAxisBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                });
            });
            
            // 颜色主题选择
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.theme-btn').forEach(b => {
                        b.classList.remove('ring-2', 'ring-offset-2');
                    });
                    
                    btn.classList.add('ring-2', 'ring-offset-2', 'ring-primary');
                    selectedTheme = btn.dataset.theme;
                });
            });
            
            // 生成图表
            generateChart.addEventListener('click', () => {
                if (!data) {
                    showNotification('错误', '请先上传数据文件', 'error');
                    return;
                }
                
                const xAxisIndex = parseInt(xAxisSelect.value);
                if (isNaN(xAxisIndex)) {
                    showNotification('错误', '请选择X轴数据列', 'error');
                    return;
                }
                
                const yAxisSelects = document.querySelectorAll('#y-axis-selectors .y-axis-selector select');
                const yAxisIndexes = [];
                
                yAxisSelects.forEach(select => {
                    const index = parseInt(select.value);
                    if (!isNaN(index) && !yAxisIndexes.includes(index)) {
                        yAxisIndexes.push(index);
                    }
                });
                
                if (yAxisIndexes.length === 0) {
                    showNotification('错误', '请至少选择一个Y轴数据列', 'error');
                    return;
                }
                
                if (yAxisIndexes.includes(xAxisIndex)) {
                    showNotification('错误', 'Y轴数据列不能与X轴相同', 'error');
                    return;
                }
                
                // 准备图表数据
                const labels = [];
                const datasets = [];
                
                for (let i = 1; i < data.length; i++) {
                    if (!data[i][xAxisIndex]) continue;
                    labels.push(data[i][xAxisIndex]);
                }
                
                yAxisIndexes.forEach((yAxisIndex, datasetIndex) => {
                    const values = [];
                    
                    for (let i = 1; i < data.length; i++) {
                        if (!data[i][xAxisIndex]) continue;
                        
                        const value = parseFloat(data[i][yAxisIndex]);
                        values.push(isNaN(value) ? data[i][yAxisIndex] : value);
                    }
                    
                    const themeColors = getThemeColors(yAxisIndexes.length);
                    
                    datasets.push({
                        label: data[0][yAxisIndex],
                        data: values,
                        backgroundColor: themeColors[datasetIndex] + '80',
                        borderColor: themeColors[datasetIndex],
                        borderWidth: 2,
                        tension: 0.3,
                        fill: false,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    });
                });
                
                if (labels.length === 0) {
                    showNotification('错误', '所选列中没有有效数据', 'error');
                    return;
                }
                
                let chartType = 'bar';
                const selectedChartType = document.querySelector('.chart-type-option.bg-primary\\/10');
                if (selectedChartType) {
                    chartType = selectedChartType.dataset.type;
                }
                
                // 准备图表配置并保存
                chartConfig = {
                    type: chartType,
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        plugins: {
                            legend: {
                                display: showLegend.checked,
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: chartTitle.value || '数据对比图表',
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(255, 255, 255, 0.9)',
                                titleColor: '#1D2129',
                                bodyColor: '#4E5969',
                                borderColor: '#E5E6EB',
                                borderWidth: 1,
                                padding: 12,
                                boxPadding: 6,
                                usePointStyle: true
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: showGrid.checked,
                                    color: 'rgba(0, 0, 0, 0.05)'
                                },
                                ticks: {
                                    color: '#4E5969'
                                }
                            },
                            y: {
                                grid: {
                                    display: showGrid.checked,
                                    color: 'rgba(0, 0, 0, 0.05)'
                                },
                                ticks: {
                                    color: '#4E5969',
                                    callback: function(value) {
                                        if (value >= 1000 && value < 1000000) {
                                            return (value / 1000).toFixed(1) + 'k';
                                        } else if (value >= 1000000) {
                                            return (value / 1000000).toFixed(1) + 'M';
                                        }
                                        return value;
                                    }
                                }
                            }
                        },
                        animations: {
                            tension: {
                                duration: 1000,
                                easing: 'linear'
                            }
                        }
                    }
                };
                
                // 特殊配置
                if (chartType === 'pie' || chartType === 'doughnut') {
                    delete chartConfig.options.scales;
                    chartConfig.options.cutout = chartType === 'doughnut' ? '65%' : '0%';
                    
                    datasets.forEach((dataset, index) => {
                        dataset.backgroundColor = getThemeColors(yAxisIndexes.length);
                        dataset.borderWidth = 1;
                        dataset.borderColor = '#fff';
                    });
                } else if (chartType === 'radar') {
                    chartConfig.options.scales = {
                        r: {
                            angleLines: {
                                display: showGrid.checked
                            },
                            grid: {
                                display: showGrid.checked
                            },
                            pointLabels: {
                                color: '#4E5969'
                            },
                            ticks: {
                                color: '#4E5969',
                                backdropColor: 'transparent'
                            }
                        }
                    };
                } else if (chartType === 'line') {
                    datasets.forEach(dataset => {
                        dataset.fill = false;
                        dataset.tension = 0.3;
                    });
                } else if (chartType === 'bar') {
                    chartConfig.options.plugins.tooltip.mode = 'index';
                    chartConfig.options.plugins.tooltip.intersect = false;
                    chartConfig.options.scales.x.stacked = false;
                    chartConfig.options.scales.y.stacked = false;
                }
                
                // 清理之前的图表
                if (chart) {
                    chart.destroy();
                }
                cleanupTemporaryCharts();
                
                // 创建新图表
                chart = new Chart(chartCanvas, chartConfig);
                
                // 获取图表的实际宽高比
                setTimeout(() => {
                    const canvasWidth = chartCanvas.clientWidth;
                    const canvasHeight = chartCanvas.clientHeight;
                    if (canvasWidth > 0 && canvasHeight > 0) {
                        chartAspectRatio = canvasWidth / canvasHeight;
                    } else {
                        chartAspectRatio = 4/3; // 保持默认比例
                    }
                }, 100);
                
                chartContainer.classList.remove('hidden');
                noChartMessage.classList.add('hidden');
                
                showNotification('成功', '图表生成成功', 'success');
            });
            
            // 根据主题获取颜色
            function getThemeColors(count) {
                const themes = {
                    blue: [
                        'rgba(22, 93, 255, 1)',
                        'rgba(45, 156, 219, 1)',
                        'rgba(129, 209, 197, 1)',
                        'rgba(217, 237, 247, 1)',
                        'rgba(174, 213, 129, 1)'
                    ],
                    green: [
                        'rgba(0, 191, 165, 1)',
                        'rgba(46, 204, 113, 1)',
                        'rgba(129, 209, 197, 1)',
                        'rgba(22, 160, 133, 1)',
                        'rgba(34, 197, 94, 1)'
                    ],
                    purple: [
                        'rgba(156, 39, 176, 1)',
                        'rgba(103, 58, 183, 1)',
                        'rgba(171, 71, 188, 1)',
                        'rgba(213, 0, 249, 1)',
                        'rgba(194, 24, 91, 1)'
                    ],
                    red: [
                        'rgba(255, 82, 82, 1)',
                        'rgba(244, 67, 54, 1)',
                        'rgba(233, 30, 99, 1)',
                        'rgba(198, 40, 40, 1)',
                        'rgba(229, 57, 53, 1)'
                    ],
                    yellow: [
                        'rgba(255, 193, 7, 1)',
                        'rgba(255, 152, 0, 1)',
                        'rgba(255, 193, 7, 1)',
                        'rgba(255, 235, 59, 1)',
                        'rgba(251, 192, 45, 1)'
                    ],
                    gray: [
                        'rgba(108, 117, 125, 1)',
                        'rgba(66, 184, 131, 1)',
                        'rgba(96, 125, 139, 1)',
                        'rgba(149, 165, 166, 1)',
                        'rgba(189, 189, 189, 1)'
                    ]
                };
                
                const colors = themes[selectedTheme];
                const result = [];
                
                for (let i = 0; i < count; i++) {
                    result.push(colors[i % colors.length]);
                }
                
                return result;
            }
            
            // 创建高分辨率图表
            function createHighResChart(width, height) {
                if (!chartConfig) return null;
                
                // 确保宽度和高度有效
                if (width <= 0 || height <= 0) {
                    console.error('无效的图表尺寸:', width, height);
                    return null;
                }
                
                cleanupTemporaryCharts();
                
                // 创建临时canvas用于高分辨率渲染
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = width;
                tempCanvas.height = height;
                
                // 设置canvas上下文属性以确保质量
                const ctx = tempCanvas.getContext('2d');
                if (ctx) {
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                }
                
                // 克隆配置并禁用动画以提高导出速度
                const highResConfig = JSON.parse(JSON.stringify(chartConfig));
                highResConfig.options.animations = false;
                highResConfig.options.responsive = false;
                highResConfig.options.maintainAspectRatio = false;
                
                try {
                    // 创建高分辨率图表
                    const highResChart = new Chart(tempCanvas, highResConfig);
                    temporaryCharts.push(highResChart);
                    
                    // 强制图表渲染
                    highResChart.update();
                    
                    return tempCanvas;
                } catch (error) {
                    console.error('创建高分辨率图表失败:', error);
                    return null;
                }
            }
            
            // 等待图表渲染完成的函数
            function waitForChartRender(canvas, maxAttempts = 20, delay = 150) {
                return new Promise((resolve, reject) => {
                    let attempts = 0;
                    
                    const checkRender = () => {
                        attempts++;
                        
                        if (attempts >= maxAttempts) {
                            reject(new Error('图表渲染超时'));
                            return;
                        }
                        
                        const ctx = canvas.getContext('2d');
                        if (!ctx) {
                            setTimeout(checkRender, delay);
                            return;
                        }
                        
                        try {
                            // 获取画布像素数据
                            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
                            
                            // 检查是否有非透明像素
                            for (let i = 3; i < imageData.length; i += 4) {
                                if (imageData[i] > 0) { // 检查alpha通道
                                    resolve();
                                    return;
                                }
                            }
                            
                            // 没有检测到渲染内容，继续等待
                            setTimeout(checkRender, delay);
                        } catch (e) {
                            console.warn('检查渲染状态时出错:', e);
                            setTimeout(checkRender, delay);
                        }
                    };
                    
                    checkRender();
                });
            }
            
            // 导出图表
            exportChart.addEventListener('click', async function() {
                if (!chart || !chartConfig) {
                    showNotification('错误', '请先生成图表', 'error');
                    return;
                }
                
                // 禁用导出按钮防止重复点击
                exportChart.disabled = true;
                exportChart.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> 导出中...';
                
                try {
                    const format = document.querySelector('.export-option.bg-primary\\/10')?.dataset.format || 'png';
                    const filename = exportFilename.value || 'chart';
                    const useWhiteBackground = bgWhite.checked;
                    
                    // 验证文件名
                    if (!filename.trim()) {
                        throw new Error('请输入有效的文件名');
                    }
                    
                    // 对于所有格式都显示进度条
                    showExportProgress();
                    
                    // 根据选择的尺寸和图表比例计算宽度和高度
                    const baseWidth = sizeSpecs[selectedSize];
                    const width = Math.max(baseWidth, 300); // 确保最小宽度
                    const height = Math.max(Math.round(width / chartAspectRatio), 200); // 确保最小高度
                    
                    // 对于PDF和SVG格式，使用不同的处理方式
                    if (format === 'pdf') {
                        // 直接使用html2canvas捕获图表容器，确保正确的背景
                        await exportAsPDF(filename, width, height, useWhiteBackground);
                    } else if (format === 'svg') {
                        // 使用改进的SVG导出方法
                        await exportAsSVG(filename, width, height, useWhiteBackground);
                    } else {
                        // 对于图片格式，使用原有的处理方式
                        updateExportProgress(30, '生成高分辨率图表', '正在准备图表数据...');
                        const highResCanvas = createHighResChart(width, height);
                        if (!highResCanvas) {
                            throw new Error('无法创建高分辨率图表');
                        }
                        
                        // 等待图表渲染完成
                        updateExportProgress(50, '等待渲染完成', '确保图表正确显示...');
                        await waitForChartRender(highResCanvas);
                        
                        // 处理图片格式导出
                        updateExportProgress(70, '处理图像数据', '正在生成最终图像...');
                        const tempCanvas = document.createElement('canvas');
                        tempCanvas.width = width;
                        tempCanvas.height = height;
                        const tempCtx = tempCanvas.getContext('2d');
                        
                        if (!tempCtx) {
                            throw new Error('无法获取Canvas上下文');
                        }
                        
                        // 处理背景
                        const effectiveBackground = format === 'jpg' ? true : useWhiteBackground;
                        if (effectiveBackground) {
                            tempCtx.fillStyle = 'white';
                            tempCtx.fillRect(0, 0, width, height);
                        }
                        
                        // 绘制高分辨率图表
                        tempCtx.drawImage(highResCanvas, 0, 0, width, height);
                        
                        let dataUrl;
                        if (format === 'png') {
                            dataUrl = tempCanvas.toDataURL('image/png');
                        } else {
                            dataUrl = tempCanvas.toDataURL('image/jpeg', 0.95);
                        }
                        
                        if (!dataUrl || dataUrl === 'data:,') {
                            throw new Error('无法生成图像数据');
                        }
                        
                        updateExportProgress(90, '准备下载', '即将完成导出...');
                        download(dataUrl, `${filename}.${format}`, `image/${format}`);
                    }
                    
                    updateExportProgress(100, '导出完成', '文件已成功导出');
                    // 短暂延迟以显示完成状态
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    showNotification('成功', `图表已导出为 ${filename}.${format}`, 'success');
                } catch (error) {
                    console.error('导出图表时出错:', error);
                    showNotification('错误', `导出图表时出错: ${error.message}`, 'error');
                } finally {
                    // 恢复导出按钮状态
                    exportChart.disabled = false;
                    exportChart.innerHTML = '<i class="fa-solid fa-download mr-2"></i> 导出图表';
                    // 清理临时资源
                    cleanupTemporaryCharts();
                    // 隐藏进度条
                    hideExportProgress();
                }
            });
            
            // 改进的SVG导出方法，包含进度更新和超时机制
            async function exportAsSVG(filename, width, height, useWhiteBackground) {
                try {
                    updateExportProgress(10, '初始化', '准备导出环境...');
                    
                    // 创建一个临时容器用于SVG导出
                    const tempContainer = document.createElement('div');
                    tempContainer.style.width = `${width}px`;
                    tempContainer.style.height = `${height}px`;
                    tempContainer.style.position = 'absolute';
                    tempContainer.style.top = '-9999px'; // 隐藏在视口外
                    tempContainer.style.left = '-9999px';
                    if (useWhiteBackground) {
                        tempContainer.style.backgroundColor = 'white';
                    }
                    
                    updateExportProgress(20, '创建临时元素', '准备渲染画布...');
                    
                    // 创建临时canvas
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = width;
                    tempCanvas.height = height;
                    tempContainer.appendChild(tempCanvas);
                    document.body.appendChild(tempContainer);
                    
                    updateExportProgress(30, '配置图表', '准备图表数据...');
                    
                    // 创建临时图表配置
                    const tempChartConfig = JSON.parse(JSON.stringify(chartConfig));
                    tempChartConfig.options.animations = false;
                    tempChartConfig.options.responsive = false;
                    tempChartConfig.options.maintainAspectRatio = false;
                    
                    updateExportProgress(40, '渲染图表', '正在生成高分辨率图表...');
                    
                    // 创建临时图表
                    const tempChart = new Chart(tempCanvas, tempChartConfig);
                    temporaryCharts.push(tempChart);
                    
                    // 强制渲染
                    tempChart.update();
                    
                    // 等待图表渲染完成
                    updateExportProgress(50, '等待渲染', '确保图表正确显示...');
                    await waitForChartRender(tempCanvas);
                    
                    updateExportProgress(70, '生成图像数据', '正在处理图表图像...');
                    
                    // 获取图表的图像数据
                    const imageData = tempCanvas.toDataURL('image/png');
                    
                    updateExportProgress(80, '创建SVG', '正在生成矢量图形...');
                    
                    // 创建SVG元素
                    const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                    svg.setAttribute("width", width);
                    svg.setAttribute("height", height);
                    svg.setAttribute("xmlns", "http://www.w3.org/2000/svg");
                    
                    // 添加背景
                    if (useWhiteBackground) {
                        const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                        rect.setAttribute("width", "100%");
                        rect.setAttribute("height", "100%");
                        rect.setAttribute("fill", "white");
                        svg.appendChild(rect);
                    }
                    
                    // 添加图表图像
                    const image = document.createElementNS("http://www.w3.org/2000/svg", "image");
                    image.setAttributeNS("http://www.w3.org/1999/xlink", "href", imageData);
                    image.setAttribute("width", width);
                    image.setAttribute("height", height);
                    svg.appendChild(image);
                    
                    updateExportProgress(90, '完成SVG', '正在完成SVG文件...');
                    
                    // 序列化SVG
                    const serializer = new XMLSerializer();
                    let svgString = serializer.serializeToString(svg);
                    
                    // 添加XML声明
                    svgString = '<?xml version="1.0" standalone="no"?>\r\n' + svgString;
                    
                    // 创建Blob并下载
                    const blob = new Blob([svgString], {type: "image/svg+xml;charset=utf-8"});
                    const url = URL.createObjectURL(blob);
                    
                    const link = document.createElement("a");
                    link.href = url;
                    link.download = `${filename}.svg`;
                    document.body.appendChild(link);
                    link.click();
                    
                    // 清理
                    setTimeout(() => {
                        document.body.removeChild(link);
                        document.body.removeChild(tempContainer);
                        URL.revokeObjectURL(url);
                    }, 100);
                    
                } catch (error) {
                    throw new Error(`SVG导出失败: ${error.message}`);
                }
            }
            
            // 改进的PDF导出方法
            async function exportAsPDF(filename, width, height, useWhiteBackground) {
                try {
                    if (typeof window.jspdf === 'undefined' || !window.jspdf.jsPDF) {
                        throw new Error('PDF库未正确加载');
                    }
                    
                    const { jsPDF } = window.jspdf;
                    
                    updateExportProgress(20, '准备图表', '正在创建临时图表...');
                    
                    // 创建一个临时容器用于捕获
                    const tempContainer = document.createElement('div');
                    tempContainer.style.width = `${width}px`;
                    tempContainer.style.height = `${height}px`;
                    tempContainer.style.position = 'absolute';
                    tempContainer.style.top = '-9999px'; // 隐藏在视口外
                    tempContainer.style.left = '-9999px';
                    if (useWhiteBackground) {
                        tempContainer.style.backgroundColor = 'white';
                    }
                    
                    // 创建一个临时canvas用于PDF导出
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = width;
                    tempCanvas.height = height;
                    tempContainer.appendChild(tempCanvas);
                    document.body.appendChild(tempContainer);
                    
                    // 创建临时图表
                    const tempChartConfig = JSON.parse(JSON.stringify(chartConfig));
                    tempChartConfig.options.animations = false;
                    tempChartConfig.options.responsive = false;
                    tempChartConfig.options.maintainAspectRatio = false;
                    
                    const tempChart = new Chart(tempCanvas, tempChartConfig);
                    temporaryCharts.push(tempChart);
                    
                    // 强制渲染
                    tempChart.update();
                    
                    // 等待图表渲染完成
                    updateExportProgress(40, '等待渲染', '确保图表正确显示...');
                    await waitForChartRender(tempCanvas);
                    
                    // 使用html2canvas捕获整个容器
                    updateExportProgress(60, '捕获图像', '正在转换为PDF格式...');
                    const canvas = await html2canvas(tempContainer, {
                        backgroundColor: useWhiteBackground ? '#ffffff' : null,
                        scale: 2, // 提高分辨率
                        logging: false
                    });
                    
                    // 转换为PDF
                    const imgData = canvas.toDataURL('image/jpeg', 0.95);
                    
                    // 计算PDF尺寸（毫米）
                    const imgWidth = 210; // A4宽度
                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    
                    // 创建PDF
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    pdf.addImage(imgData, 'JPEG', 0, 0, imgWidth, imgHeight);
                    
                    updateExportProgress(80, '生成PDF', '正在完成PDF文件...');
                    pdf.save(`${filename}.pdf`);
                    
                    // 清理临时元素
                    document.body.removeChild(tempContainer);
                    
                } catch (error) {
                    throw new Error(`PDF导出失败: ${error.message}`);
                }
            }
            
            // 下载文件
            function download(dataUrl, filename, mimeType) {
                try {
                    if (!dataUrl || dataUrl === 'data:,') {
                        throw new Error('无效的文件数据');
                    }
                    
                    const link = document.createElement('a');
                    link.href = dataUrl;
                    link.download = filename;
                    
                    // 对于某些浏览器需要模拟点击
                    const event = new MouseEvent('click', {
                        view: window,
                        bubbles: true,
                        cancelable: true
                    });
                    
                    document.body.appendChild(link);
                    link.dispatchEvent(event);
                    
                    // 清理
                    setTimeout(() => {
                        document.body.removeChild(link);
                    }, 100);
                } catch (error) {
                    throw new Error(`下载文件失败: ${error.message}`);
                }
            }
            
            // 显示通知
            function showNotification(title, message, type) {
                notificationMessage.textContent = `${title}: ${message}`;
                
                if (type === 'success') {
                    notification.className = 'fixed top-4 right-4 p-4 rounded-lg shadow-lg transform transition-all duration-300 translate-x-0 opacity-100 z-50 flex items-center bg-green-50 text-green-800 border-l-4 border-green-400';
                    notificationIcon.className = 'fa-solid fa-check-circle text-green-500 mr-2';
                } else if (type === 'error') {
                    notification.className = 'fixed top-4 right-4 p-4 rounded-lg shadow-lg transform transition-all duration-300 translate-x-0 opacity-100 z-50 flex items-center bg-red-50 text-red-800 border-l-4 border-red-400';
                    notificationIcon.className = 'fa-solid fa-exclamation-circle text-red-500 mr-2';
                } else if (type === 'info') {
                    notification.className = 'fixed top-4 right-4 p-4 rounded-lg shadow-lg transform transition-all duration-300 translate-x-0 opacity-100 z-50 flex items-center bg-blue-50 text-blue-800 border-l-4 border-blue-400';
                    notificationIcon.className = 'fa-solid fa-info-circle text-blue-500 mr-2';
                }
                
                notification.style.transform = 'translateX(0)';
                notification.style.opacity = '1';
                
                const timeout = type === 'error' ? 8000 : 3000;
                clearTimeout(notification.timeoutId);
                notification.timeoutId = setTimeout(() => {
                    notification.style.transform = 'translateX(calc(100% + 1rem))';
                    notification.style.opacity = '0';
                }, timeout);
            }
            
            // 关闭通知
            closeNotification.addEventListener('click', () => {
                notification.style.transform = 'translateX(calc(100% + 1rem))';
                notification.style.opacity = '0';
            });
            
            // 为所有导出选项添加点击事件
            document.querySelectorAll('.export-option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('.export-option').forEach(opt => {
                        opt.classList.remove('bg-primary/10', 'text-primary');
                    });
                    
                    option.classList.add('bg-primary/10', 'text-primary');
                });
            });
            
            // 平滑滚动
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    
                    const targetId = this.getAttribute('href');
                    const targetElement = document.querySelector(targetId);
                    
                    if (targetElement) {
                        window.scrollTo({
                            top: targetElement.offsetTop - 80,
                            behavior: 'smooth'
                        });
                    }
                });
            });
            
            // 初始化Y轴选择器
            resetYAxisSelectors();
            
            console.log('数据可视化工具脚本已加载');
        });
    </script>
</body>
</html>
